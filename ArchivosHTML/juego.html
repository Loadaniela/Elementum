<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego Bloques</title>
    <link rel="stylesheet" href="css/juego.css">
</head>
<body>
    <main>
    <input type="checkbox" id="toggle">
    <label for="toggle" class="hamburger"><span></span></label>
    <nav class="menu">
        <ul>
            <li><a href="#">PERFIL DEL JUGADOR</a></li>
            <p><strong style="color: orange;">Jugador:</strong> <span id="nombre" style="color: white;"></span></p>
            <p><strong style="color: orange;">Correo:</strong> <span id="correo" style="color: white;"></span></p>
            <p><strong style="color: orange;">Usuario:</strong> <span id="usuario" style="color: white;"></span></p>
            <li><a href="pagina1.html">Menú Principal</a></li>
            <li><a href="login.html" id="logout">Cerrar sesión</a></li>
            <img src="Imagenes/oncahui.png" alt="panda" width="220" height="350">
        </ul>
    </nav>

   <!--- <h1 class="glitch"  data-text="Elementum">ELEMENTUM</h1>
    <p class="arrastres"><strong style="color: orange;">Número de arrastres realizados:</strong> <span id="contadorArrastres" style="color: white;">0</span></p>
-->
    <div id="menuoculto">
        <a id="menu1" href="#">Arrastra los nombres de los bloques a su lugar correspondiente </a>
 </div>
 <!--ELEMENTOS DE LA TABLA PERIODICA-->  
 
 <!--INICIA EL BLOQUE S-->
<div class="contenedor"> 
    <!--AQUI INICIA EL CONTENEDOR PADRE-->
    <h1 class="glitch"  data-text="Elementum">ELEMENTUM</h1>
    <p class="arrastres"><strong style="color: orange;">Número de arrastres realizados:</strong> <span id="contadorArrastres" style="color: white;">0</span></p>
  
 <div class="bloqueS" id="bloqueS" ondrop="drop(event)" ondragover="allowDrop(event)" >
<div class="gas" id="eq1">

 </div>

 <div class="alcalino" id="eq3">
     
 </div>
 
<div class="alcalino" id="eq11">
     
 </div>
 
 <div class="alcalino" id="eq19">
   
 </div>
 
 <div class="alcalino" id="eq37">
     
 </div>
 
<div class="alcalino" id="eq55">
    
 </div>
 
 <div class="alcalino" id="eq87">
     
 </div>
   
 <div class="alcalinoterreos" id="eq4">

 </div>
     
 <div class="alcalinoterreos" id="eq12">

 </div>
     
 <div class="alcalinoterreos" id="eq20">
    
 </div>

 <div class="alcalinoterreos" id="eq38">
     
 </div>
     
 <div class="alcalinoterreos" id="eq56">
   
 </div>
     
 <div class="alcalinoterreos" id="eq88">

 </div>
</div>
<!--AQUI TERMINA EL BLOQUE S-->


<div class="bloqueP" id="bloqueP" ondrop="drop(event)" ondragover="allowDrop(event)">
 <!--AQUI INICIA EL BLOQUE D-->
       
 <div class="transicion" id="eq21" style="color:  #4931AF;">
     
 </div>
         
 <div class="transicion" id="eq39">
    
 </div>
         
 <div class="lantanidos" id="eq5771">
    
 </div>
         
 <div class="actinidos" id="eq89103">
   
 </div>
         
 <div class="transicion" id="eq22">
     
 </div>
         
<div class="transicion" id="eq40">
     
 </div>
         
 <div class="transicion" id="eq72">
    
 </div>
         
<div class="transicion" id="eq104">
 
 </div>
           
 <div class="transicion" id="eq23">
     
 </div>
           
<div class="transicion" id="eq41">
     
 </div>
           
 <div class="transicion" id="eq73">
     
 </div>
           
 <div class="transicion" id="eq105">
    
 </div>
      
 <div class="transicion" id="eq24">
    
 </div>
             
 <div class="transicion" id="eq42">
     
 </div>
             
 <div class="transicion" id="eq74">
     
 </div>
             
 <div class="transicion" id="eq106">
     
 </div>
               
<div class="transicion" id="eq25">
    
 </div>
             
 <div class="transicion" id="eq43">
     
 </div>
             
 <div class="transicion" id="eq75">
     
 </div>
             
 <div class="transicion" id="eq107">
    
 </div>
    
 <div class="transicion" id="eq26">
    
 </div>
             
 <div class="transicion" id="eq44">
     
 </div>
             
 <div class="transicion" id="eq76">
     
 </div>
             
 <div class="transicion" id="eq108">
    
 </div>
      
 <div class="transicion" id="eq27">
     
 </div>
             
 <div class="transicion" id="eq45">
     
 </div>
             
 <div class="transicion" id="eq77">
     
 </div>
             
 <div class="transicion" id="eq109">
     
 </div>
        
 <div class="transicion" id="eq28">
    
 </div>
             
<div class="transicion" id="eq46">
    
 </div>
             
 <div class="transicion" id="eq78">
    
 </div>
             
 <div class="transicion" id="eq110">
     
 </div>
          
 <div class="transicion" id="eq29">
     
 </div>
             
 <div class="transicion" id="eq47">
   
 </div>
             
 <div class="transicion" id="eq79">
    
 </div>
             
 <div class="transicion" id="eq111">
     
 </div>
            
 <div class="transicion" id="eq30">
     
 </div>
             
 <div class="transicion" id="eq48">
     
 </div>
             
 <div class="transicion" id="eq80">
     
 </div>
             
 <div class="transicion" id="eq112">
    
 </div>
</div>
<!--AQUI TERMINA EL BLOQUE D-->

<div class="bloqueD" id="bloqueD" ondrop="drop(event)" ondragover="allowDrop(event)">               
 <div class="metaloides" id="eq5">
    
 </div>
                 
 <div class="metales" id="eq13">
     
 </div>
                   
 <div class="metales" id="eq31">
    
 </div>
                   
 <div class="metales" id="eq49">
    
 </div>
                   
<div class="metales" id="eq81">
     
 </div>
                   
 <div class="desconocidos" id="eq113">
     
 </div>
                 
 <div class="gas" id="eq6">
    
 </div>

 <div class="metaloides" id="eq14">
    
 </div>
 
<div class="metaloides" id="eq32">
     
 </div>

 <div class="metales" id="eq50">
   
 </div>
 
 <div class="metales" id="eq82">
     
 </div>

 <div class="desconocidos" id="eq114">
     
 </div>
                   
<div class="gas" id="eq7">
     
 </div>

 <div class="gas" id="eq15">
    
 </div>
 
 <div class="metaloides" id="eq33">
     
 </div>

 <div class="metaloides" id="eq51">
    
 </div>
 
 <div class="metales" id="eq83">
     
 </div>

 <div class="desconocidos" id="eq115">
    
 </div>
                     
 <div class="gas" id="eq8">
     
 </div>

 <div class="gas" id="eq16">
    
 </div>
 
 <div class="gas" id="eq34">
    
 </div>

 <div class="metaloides" id="eq52">
     
 </div>
 
<div class="metaloides" id="eq84">
    
 </div>

 <div class="desconocidos" id="eq116">
    
 </div>
                       
 <div class="halogenos" id="eq9">
     
 </div>

 <div class="halogenos" id="eq17">
    
 </div>
 
<div class="halogenos" id="eq35">
     
 </div>

 <div class="halogenos" id="eq53">
     
 </div>
 
 <div class="halogenos" id="eq85">
    
 </div>

<div class="desconocidos" id="eq117">
     
 </div>
                         
<div class="nobles" id="eq2">
    
 </div>
                       
 <div class="nobles" id="eq10">
    
 </div>

<div class="nobles" id="eq18">
    
 </div>
 
<div class="nobles" id="eq36">
    
 </div>

<div class="nobles" id="eq54">
     
 </div>
 
<div class="nobles" id="eq86">
     
 </div>

 <div class="desconocidos" id="eq118">
     
 </div>
</div>
<!--AQUI TERMINA EL BLOQUE P-->


<div class="bloqueF" id="bloqueF" ondrop="drop(event)" ondragover="allowDrop(event)"> 
<!--AQUI INICIA EL BLOQUE F-->
 <div class="lantanidos" id="eq57">
    
 </div>
 
 <div class="lantanidos" id="eq58">
     
 </div>
 
 <div class="lantanidos" id="eq59">
     
 </div>
 
 <div class="lantanidos" id="eq60">
     
 </div>
 
 <div class="lantanidos" id="eq61">
    
 </div>
 
 <div class="lantanidos" id="eq62">
    
 </div>
 
<div class="lantanidos" id="eq63">
     
 </div>
 
<div class="lantanidos" id="eq64">
     
 </div>
 
 <div class="lantanidos" id="eq65">
     
 </div>
 
 <div class="lantanidos" id="eq66">
     
 </div>
 
 <div class="lantanidos" id="eq67">
    
 </div>

 <div class="lantanidos" id="eq68">
    
 </div>
 
<div class="lantanidos" id="eq69">
    
 </div>

<div class="lantanidos" id="eq70">
    
 </div>

 <div class="lantanidos" id="eq71">
    
 </div>

<div class="actinidos" id="eq89">
    
 </div>
 
<div class="actinidos" id="eq90">
     
 </div>
 
<div class="actinidos" id="eq91">
    
 </div>
 
<div class="actinidos" id="eq92">
    
 </div>
 
<div class="actinidos" id="eq93">
    
 </div>
 
 <div class="actinidos" id="eq94">
    
 </div>
 
 <div class="actinidos" id="eq95">
    
 </div>
 
 <div class="actinidos" id="eq96">
     
 </div>
 
 <div class="actinidos" id="eq97">
    
 </div>
 
 <div class="actinidos" id="eq98">
    
 </div>
 
 <div class="actinidos" id="eq99">
    
 </div>
 
 <div class="actinidos" id="eq100">
    
 </div>
 
 <div class="actinidos" id="eq101">
    
 </div>

 <div class="actinidos" id="eq102">
    
 </div>

<div class="actinidos" id="eq103">
    
     </div>
   
<!--AQUI TERMINA EL BLOQUE F-->

<div class="bloquesN">
    <div class="bloques" id="S" draggable="true" ondragstart="drag(event)"><strong>Representativos</strong></div>
    <div class="bloques" id="P" draggable="true" ondragstart="drag(event)"><strong>Transición</strong></div>
    <div class="bloques" id="D" draggable="true" ondragstart="drag(event)"><strong>Nobles</strong></div>
    <div class="bloques" id="F" draggable="true" ondragstart="drag(event)"><strong>Transición interna</strong></div>
</div>
</div>

</main>

<script>
    document.addEventListener('DOMContentLoaded', function() {
                fetch('/perfil')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('No autorizado');
                        }
                        return response.json();
                    })
                    .then(data => {
                        document.getElementById('nombre').textContent = data.nombre;
                        document.getElementById('correo').textContent = data.correo;
                        document.getElementById('usuario').textContent = data.usuario;
                    })
                    .catch(error => {
                        console.error('Error al cargar el perfil:', error);
                        alert('Debes iniciar sesión primero');
                        window.location.href = '/login.html';
                    });
            });


                        // Función para obtener el ID del juego desde la URL
            function obtenerIdJuegoDeURL() {
                const urlActual = window.location.pathname; // Obtiene la ruta del archivo
                if (urlActual.includes('juego.html')) return 1;
                if (urlActual.includes('juego2.html')) return 2;
                if (urlActual.includes('juego3.html')) return 3;
                if (urlActual.includes('juego4.html')) return 4;
                return null; // En caso de que no se encuentre un juego válido
            }

            // Función para registrar la entrada del usuario al juego
            function registrarEntradaJuego(userId, juegoId) {
                fetch('/api/entrada-juego', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userId, juegoId })
                })
                .then(response => response.json())
                .then(data => console.log('Entrada registrada:', data))
                .catch(error => console.error('Error registrando entrada:', error));
            }

            document.getElementById('logout').addEventListener('click', function(e) {
                e.preventDefault();
                fetch('/logout', { method: 'POST' })
                    .then(response => {
                        if (response.ok) {
                            window.location.href = '/login.html';
                        } else {
                            throw new Error('Error al cerrar sesión');
                        }
                    })
                    .catch(error => {
                        console.error('Error al cerrar sesión:', error);
                        alert('Error al cerrar sesión');
                    });
            });

  </script>

<script>

    // Variable para indicar si el juego ha terminado
let juegoTerminado = false;

// Manejo del evento beforeunload
window.addEventListener('beforeunload', function (event) {
    if (!juegoTerminado) { // Solo muestra el mensaje si el juego no ha terminado
        const message = "Estás a punto de salir del juego. Los datos podrían no guardarse.";
        event.returnValue = message;
        return message;
    }
});

// Manejo del evento popstate
window.addEventListener('popstate', function (event) {
    if (!juegoTerminado) { // Solo muestra el mensaje si el juego no ha terminado
        const confirmExit = confirm("Estás a punto de salir del juego. Los datos podrían no guardarse.");
        if (!confirmExit) {
            // Si el usuario decide no salir
            history.pushState(null, null, window.location.href);
        }
    }
});


</script>


<!--funcion para hacer los arrastres -->
<script>
    
    // Variable para contar el número de arrastres
    let arrastresContador = 0;
    // Total de elementos que deben ser arrastrados correctamente
    const totalElementos = document.querySelectorAll('.bloques[draggable="true"]').length;
    // Contador de elementos correctos colocados
    let correctosContador = 0;

    const sonidoAcierto = new Audio('audio/acierto.mp3'); // Ruta al archivo de sonido de acierto
    const sonidoError = new Audio('audio/error.mp3'); // Ruta al archivo de sonido de error

    // Función que permite el arrastre
    function drag(event) {
        event.dataTransfer.setData("text", event.target.id);
    }

    // Función que permite soltar el elemento sobre un contenedor
    function allowDrop(event) {
        event.preventDefault();
    }

    // Función que maneja la acción de soltar el elemento
    function drop(event) {
        event.preventDefault();
        arrastresContador++; // Incrementa el contador de arrastres
        var data = event.dataTransfer.getData("text");
        var element = document.getElementById(data);
        
        // Identifica el contenedor al que se intenta soltar
        var targetContainer = event.target.closest('.bloqueS, .bloqueD, .bloqueP, .bloqueF');
        
        // Verifica si el contenedor existe y si es el correcto
        if (targetContainer && targetContainer.id === "bloque" + data) {
            // Calcula la posición relativa al contenedor
            var rect = targetContainer.getBoundingClientRect();
            var elemRect = element.getBoundingClientRect();
            var offsetX = event.clientX - elemRect.width / 2;
            var offsetY = event.clientY - elemRect.height / 2;

            // Ajusta la posición del elemento para que quede sobre el contenedor
            element.style.position = "absolute";
            element.style.left = offsetX + "px";
            element.style.top = offsetY + "px";
            
            // Deshabilita el arrastre del elemento para que no pueda ser movido nuevamente
            element.setAttribute("draggable", "false");
            element.style.cursor = "default"; // Cambia el cursor a normal
            // Incrementa el contador de elementos correctos
            correctosContador++;
            sonidoAcierto.play(); // Reproduce el sonido de acierto
        } else {
            sonidoError.play(); // Reproduce el sonido de error
        }
        // Actualiza el contador de arrastres en la página
        document.getElementById("contadorArrastres").textContent = arrastresContador;
        
        // Verifica si todos los elementos han sido colocados correctamente
        if (correctosContador === totalElementos) {
            alert("¡Felicidades! Has colocado todos los elementos correctamente en " + arrastresContador + " arrastres.");
            
            // Guardar el resultado del juego en la base de datos
            const userId = document.getElementById('usuario').textContent; // Obtener el userId del perfil cargado
            const juegoId = obtenerIdJuegoDeURL(); // Obtener el ID del juego actual
            
            // Llamar a la función para guardar el resultado
            guardarResultadoJuego(userId, juegoId, arrastresContador);
        }
    }

    // Función para guardar el resultado del juego
    function guardarResultadoJuego(userId, juegoId, numArrastres) {
    const nombreJuego = obtenerNombreJuego(juegoId);

    fetch('/guardar-resultado', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ userId, juegoId, numArrastres })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Resultado guardado:', data);

        if (data.message === 'Resultado guardado correctamente') {
             // Indicar que el juego ha terminado
             juegoTerminado = true;
            window.location.href = 'marcador.html';
        } else {
            alert('Error al guardar resultados: ' + (data.error || 'Error desconocido'));
            console.error('Detalles del error:', data);
        }
    })
    .catch(error => {
        console.error('Error de red:', error);
        alert('Error de red, por favor intenta nuevamente.');
    });
}
//los casos de los switch estan en prueba.js
function obtenerNombreJuego(juegoId) {
        switch (parseInt(juegoId)) {
            case 1: return 'Bloques';
            case 2: return 'Elementos';
            case 3: return 'RadioA';
            case 4: return 'Electronegatividad';
            default: return 'Juego desconocido';
        }
    }


</script>

    

  </body>
</html>